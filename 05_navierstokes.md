# Flow of a Newtonian fluid with inertia: the Navier-Stokes equations

In this chapter we consider the flow of incompressible Newtonian fluids where inertia cannot be neglected. These flows can be modelled by the (incompressible) Navier-Stokes equations, Equations {eq}`eq48-chap1`. There is a wide range of applications for the (incompressible) Navier-Stokes equations: from flow of blood in arteries to flow in chemical reactors.  

The finite element discretization will be similar to the Stokes equations in {numref}`Chap3`. However, the resulting space-discretized equations are both *time-dependent* and *nonlinear*. The time-dependence requires discretization in time in addition to discretization in space. Several time-discretization schemes will be discussed. The nonlinearity of the equations requires iteration to obtain a solution. Two iteration methods will be discussed: Picard and Newton-Raphson.

## Problem formulation

The momentum and mass balance are given by Equations {eq}`eq40-chap1` and {eq}`eq46-chap1` and read

$$
\begin{alignat*}{2}
  \rho \derivmat{\vek u}t-\nao\cdot\ten \sigma^T &= \vek f &\qquad &\text{in }\Omega \\
   \nao\cdot\vek u&=0&\qquad&\text{in }\Omega
\end{alignat*}
$$ (eq1-chap5)

For a Newtonian fluid given by the constitutive equation Equation {eq}`eq45-chap1`, together with the
Cauchy stress expression Equation {eq}`eq36-chap1`, these reduce to the Navier-Stokes equations Equations {eq}`eq48-chap1`, which we repeat here:

$$
\begin{alignat*}{2}
 \rho \derivmat{\vek u}t-\nao\cdot(2\mu \ten D)+\nao p &=\vek f&&\text{in }\Omega \\
   \nao\cdot\vek u&=0&\qquad&\text{in }\Omega
\end{alignat*}
$$ (eq2-chap5)

Since in this chapter we solve the Navier-Stokes equation in a fixed domain $\Omega$, we split the substantial (material) derivative into a local (partial) time derivative and a convective term:

$$
\begin{alignat*}{2}
 \rho (\pderiv{\vek u}t+\vek u\cdot\nao\vek u)-\nao\cdot(2\mu \ten D)+\nao p &=\vek f&&\text{in }\Omega \\
   \nao\cdot\vek u&=0&\qquad&\text{in }\Omega
\end{alignat*}
$$ (eq3-chap5)

The velocity and pressure that need to be obtained from this equation are now functions of position $\vek x\in \Omega$ and time $t>0$, denoted by $\vek u(\vek x,t)$ and $p(\vek x,t)$.

The boundary conditions are similar to the Stokes equations and assumed to be

$$
\begin{alignat*}{2}
    \vek u &= \vek u_\text{D}&&\qquad\text{ on }\Gamma_D\\
    \ten\sigma\cdot\vek n=-p\vek n+2\mu \ten D\cdot\vek n&=\vek t_{\text{N}} &&\qquad\text{ on }\Gamma_{\text{N}}
\end{alignat*}
$$ (eq4-chap5)

where the boundary $\Gamma=\Gamma_\text{D}\cup\Gamma_{\text{N}}$ and has been split into a
*Dirichlet* and a *Neumann* part (see {numref}`fig1-chap5`). The Neumann boundary condition is equivalent to an imposed traction of $\vek t_{\text{N}}$. The imposed boundary values $\vek u_\text{D}$ and $\vek t_{\text{N}}$ are functions of both space $\vek x\in\Omega$ and time $t>0$. 

In addition to the boundary conditions, initial conditions for the velocity field need to be specified:

$$
  \vek u(\vek x,t=0) = \vek u_0(\vek x) \qquad \text{in }\Omega 
$$ (eq5-chap5)

Initial conditions for the pressure field are not needed/not allowed. 
```{admonition} Remark 5.1
:class: note

Formally, the incompressibility constraint {eq}`eq3-chap5` (second constraint) and the Dirichlet boundary condition
{eq4-chap5} (first constraint) are only imposed for $t>0$. Therefore, the initial velocity field $\vek u_0$ in Equation {eq}`eq5-chap5` does not have to obey these conditions. However note that, any velocity jump in time from $t=0$ to $t=0^+$ would mean infinite acceleration that can only be generated by infinite velocity gradients and/or infinite pressure gradients. For example, setting a wall into motion instantly generates an infinite velocity gradient (a jump of velocity in space) near the wall at $t=0^+$, that smoothes out in time by viscosity. Although this seems like a perfectly valid fluid mechanics problem, don't expect the numerical solution to obey the formal accuracy in space and time as expected for smooth solutions. It is advised to at least set $\nao\cdot\vek u_0=0$, since there does not seem to be any physical reason to assume compression of a fluid that is assumed incompressible for $t>0$.

```

```{admonition} Remark 5.2
:class: note

In case the Dirichlet boundary $\Gamma_\text{D}$ covers the whole boundary $\Gamma$, a pressure level needs to be specified, like in the Stokes equations, but now it needs to be maintained for all times $t>0$. Also the compatibility condition Equation {eq4-chap3} needs to be fullfilled for $\vek u_\text{D}$ and be valid for all times $t>0$.

```

Assuming the boundary conditions {eq}`eq4-chap5` become independent of time for $t>t_\text{s}$, it is possible that $\plderiv{\vek u}t\rightarrow0$ for $t\rightarrow\infty$. In other words: the flow becomes *steady*. Steady flow must obey the *steady Navier-Stokes equations*:

$$
\begin{alignat*}{2}
 \rho \vek u\cdot\nao\vek u-\nao\cdot(2\mu \ten D)+\nao p &=\vek f&&\text{in }\Omega \\
   \nao\cdot\vek u&=0&\qquad&\text{in }\Omega
\end{alignat*}
$$ (eq6-chap5)

Although any steady flow must obey these equations, it doesn't mean that a solution of these equations is stable. Sometimes steady solutions cannot be maintained because very small perturbation grow in time. These solutions are *unstable*. For example for a flow past a cylinder at low flow rates, steady solutions exist. For higher flow rates, however, the flow becomes unstable and the so-called time-periodic vortex shedding phenomenon appears {cite}`Tritton1988`. 

Introducing a characteristic velocity $U$ and characteristic length scale $L$ for a particular flow problem, we can scale the steady Navier-Stokes equations using

$$
   \vek u = U\vek u^*, \qquad \nao = \frac1L\nao^*, \qquad p=\frac{\mu U}Lp^*, \qquad \vek f=\frac{\mu U}{L^2}\vek f^* 
$$ (eq7-chap5)

and obtain

$$
\begin{alignat*}{2}
 \textit{Re}\, \vek u^*\cdot\nao^*\vek u^*-\nao^*\cdot(2\ten D^*)+\nao^* p^* &=\vek f^*&&\text{in }\Omega \\
   \nao^*\cdot\vek u^*&=0&\qquad&\text{in }\Omega
\end{alignat*}
$$ (eq8-chap5)

where the dimensionless group $\textit{Re}$, the *Reynolds number*, has been defined as

$$
  \textit{Re} =\frac{\rho U L}\mu
$$ (eq9-chap5)

The Reynolds number $\textit{Re}$ can be interpreted as the ratio of the inertia forces to the viscous forces in the flow. When increasing the Reynolds number from zero, at some point the flow becomes unstable. For example, the flow past a sphere becomes unstable for $\mathit{Re}\approx40$. For high values of \textit{Re} ($\textit{Re}>2\cdot10^5$) the boundary layer around the sphere becomes fully turbulent.

In the next section, we present the weak formulation of the time-dependent Navier-Stokes equations. The steady Navier-Stokes equations will be considered as a special case of the time-dependent one.

## Weak formulation

The Navier-Stokes equations are time-dependent PDE's.
In deriving the weak formulation for time-dependent PDE's we need to make a choice about the sequence of discretization {cite}`Gross2011`: the method of lines (first space then time), the Rothe approach (first time and then space) or space-time (space and time simultaneously). In these lecture notes we follow the method of lines, which combined with the ALE approach (see {numref}`Chap6.1`) is a rather straightforward technique. The Rothe approach allows, in principle, for a different spatial mesh at each discrete time instant, but is also more difficult to implement. The space-time approach allows for a mesh in space and time simultaneously. It is the ultimate in flexibility, but it is even more difficult to implement than the Rothe approach.

In order to derive the weak form of the Navier-Stokes equations, we start from the general system Equations {eq}`eq1-chap5`. We apply the method of lines and leave the time-derivative as it is. Multiplying Equations {eq}`eq1-chap3` with test functions $\vek v$ and $q$, respectively, and integrating
over the domain $\Omega$ we obtain

$$
\begin{align*}
 \int_\Omega \vek v\cdot(\rho \derivmat{\vek u}t-\nao\cdot\ten\sigma^T-\vek f)\,d\Omega &=0\\
 \int_\Omega q\nao\cdot\vek u\,d\Omega &=0
\end{align*}
$$ (eq10-chap5)

for all test functions $\vek v\in \vek V$ and $q\in Q$. Compared to the Stokes equations (see Equations {eq}`eq5-chap3`), only the inertia term $\rho\lderivmat{\vek u}t$ has been added. Therefore, we can use the derivation of the weak form of the Stokes equation in {numref}`Chap3.2` with the inertia term added and arrive at the following *weak form of the Navier-Stokes equations*: 
find $\vek u\in \vek U$, $p\in P$ such that

$$
\begin{gather*}
\begin{split}
\int_\Omega \rho\vek v\cdot\pderiv{\vek u}t\,d\Omega
+\int_\Omega \rho\vek v\cdot(\vek u\cdot\nao\vek u)\,d\Omega\hspace{6cm}\\
 +\int_\Omega \mu(\nao\vek v)^T:(\nao\vek u+(\nao\vek u)^T)\,d\Omega
    -\int_\Omega\nao\cdot\vek vp\,d\Omega\hspace{2cm}\\
        =\int_{\Gamma_\text{N}} \vek v\cdot\vek t_\text{N}\,d\Gamma +\int_\Omega \vek v\cdot\vek f\,d\Omega
\end{split}
\\
  \int_\Omega q\nao\cdot\vek u\,d\Omega =0
\end{gather*}
$$ (eq11-chap5)

for all $\vek v\in \vek V$ and $q\in Q$. Note, that we have split the substantial derivative into a local time-derivative and a convection term. By setting the local time-derivative to zero, i.e. $\plderiv{\vek u}t=\vek 0$, we arrive at the *weak form of the steady Navier-Stokes equations*: 
find $\vek u\in \vek U$, $p\in P$ such that

$$
\begin{gather*}
\begin{split}
\int_\Omega \rho\vek v\cdot(\vek u\cdot\nao\vek u)\,d\Omega
 +\int_\Omega \mu(\nao\vek v)^T:(\nao\vek u+(\nao\vek u)^T)\,d\Omega
    -\int_\Omega\nao\cdot\vek vp\,d\Omega\qquad\qquad\\
        =\int_{\Gamma_\text{N}} \vek v\cdot\vek t_\text{N}\,d\Gamma +\int_\Omega \vek v\cdot\vek f\,d\Omega
\end{split}
\\
  \int_\Omega q\nao\cdot\vek u\,d\Omega =0
\end{gather*}
$$ (eq12-chap5)

for all $\vek v\in \vek V$ and $q\in Q$


## The Galerkin method

For the discretization with the Galerkin method we can follow the same approach as in {numref}`Chap3.3` for the Stokes equations. We only need to add the inertia terms.

The discretized equations for the flow of a Newtonian fluid with inertia can be obtained by replacing the general spaces with the finite dimensional approximation spaces in the weak form Equations {eq}`eq11-chap5`: find $\vek u_h\in \vek U_h$, $p_h\in P_h$ such that

$$
\begin{gather*}
\begin{split}
\int_\Omega \rho\vek v_h\cdot\pderiv{\vek u_h}t\,d\Omega
+\int_\Omega \rho\vek v_h\cdot(\vek u_h\cdot\nao\vek u_h)\,d\Omega\hspace{6cm}\\
 +\int_\Omega \mu(\nao\vek v_h)^T:(\nao\vek u_h+(\nao\vek u_h)^T)\,d\Omega
    -\int_\Omega\nao\cdot\vek v_hp_h\,d\Omega\hspace{2cm}\\
        =\int_{\Gamma_\text{N}} \vek v_h\cdot\vek t_\text{N}\,d\Gamma +\int_\Omega \vek v_h\cdot\vek f\,d\Omega
\end{split}
\\
  \int_\Omega q_h\nao\cdot\vek u_h\,d\Omega =0
\end{gather*}
$$ (eq13-chap5)

for all $\vek v_h\in \vek V_h$ and $q_h\in Q_h$.
The approximation spaces for velocity and pressure can be taken the same as for the Stokes equations.
Using Equations {eq}`eq15-chap3`-{eq}`eq16-chap3` together with Equations {eq}`eq20-chap3` the following set of discretized equations can be derived:

$$
\begin{align*}
   \sum_{m=1}^{N_u} \ten M_{km}\cdot \deriv{\vek u_m}{t}+\vek N_k(\vek u_h) + \sum_{m=1}^{N_u} \ten A_{km}\cdot \vek u_m + \sum_{m=1}^{N_p} \vek b_{mk}p_m
  &=\vek f_k, \qquad k=1,\dots N_{u} \\
  \sum_{m=1}^{N_u}\vek b_{km}\cdot \vek u_m&=0, \qquad k=1,\dots N_{p}
\end{align*}
$$ (eq14-chap5)

where $\ten A_{km}$, $\vek b_{km}$ and $\vek f_k$ are the same as for Stokes (Equations {eq}`eq22-chap3` (first two equations)), the tensors $\ten M_{km}$ and the vectors $\vek N_{k}(\vek u_h)$ are defined as

$$
\begin{align*}
\ten M_{km} &= \int_\Omega \rho \phi_k\phi_m\ten I\,d\Omega, \qquad
  k,m=1,\dots N_{u}\\
 \vek N_{k}(\vek u_h) &= \int_\Omega \rho \phi_k\vek u_h\cdot\nao\vek u_h\,d\Omega, \qquad
  k=1,\dots N_{u}
\end{align*}
$$ (eq15-chap5)

Note, that the time-derivative in Equation {eq}`eq14-chap5` (first equation) is just an ordinary one, i.e. not a partial derivative. Also note, that the tensors $\ten M_{km}$ are proportional to the indentity tensor with a proportionality factor given by

$$
      M_{km}= \int_\Omega \rho \phi_k\phi_m\,d\Omega, \qquad
  k,m=1,\dots N_{u}
$$ (eq16-chap5)

````{exercise}
:label: ex:5.1

Derive the expressions for $\ten M_{km}$ and $\vek N_k(\vek u_h)$ as given by Equations {eq}`eq15-chap5`.

````

Now we define the matrix $\mat M$ and column vector $\col N(\col u)$ as follows

$$
   \mat{M}=  
  \begin{pmatrix}
    \mat{M}_{11} & \mat{M}_{12} & \cdots & \mat{M}_{1N_u} \\
    \mat{M}_{21} & \mat{M}_{22} & \cdots & \mat{M}_{2N_u} \\
      \vdots & \vdots & \ddots & \vdots \\
    \mat{M}_{N_u1} & \mat{M}_{N_u2} & \cdots & \mat{M}_{N_uN_u}
  \end{pmatrix},\qquad
       \col{N}(\col{u})=  
  \begin{pmatrix}
    \col{N}_{1} \\
    \col{N}_{2} \\
      \vdots  \\
    \col{N}_{N_u} 
  \end{pmatrix} 
$$ (eq17-chap5)

with $\mat{M_{km}}$ the $d\times d$ matrix of the components of the tensor $\ten M_{km}$ and $\col{N_{k}}$ the column of size $d$ of the components of $\vek N_{k}(\vek u_h)$. The components are taken with respect to a Cartesian coordinate system given by the unit vectors $\vek e_i$, $i=1,\dots,d$. The column vector $\col{u}$ is the vector of unknown velocities defined identically to the Stokes equations (see Equation {eq}`eq24-chap3` (second equation)). The system given by Equations {eq}`eq14-chap5` can now be written in a matrix form as follows

$$
\begin{align*}
\mat{M} \deriv{\smash{\col{u}}}t+\col{N}(\col{u}) +\mat{A}\col{u}+\mat{B^T}\col{p} &= \col{f} \\
   \mat{B}\col{u}  &= \col{0} 
\end{align*}
$$ (eq18-chap5)

The column vectors $\col p$, $\col f$ and matrices $\mat A$, $\mat B$ are the same as for the Stokes equations (see Equations {eq}`eq24-chap3`). The matrix $\mat M$ is called the *mass matrix*.

````{exercise}
:label: ex:5.2

 Show that the mass matrix $\mat M$ is symmetric, and positive definite, i.e. $\mat{M^T}=\mat{M}$ and

$$
    \col{a^T}\mat{M} \col{a}>0, \text{ for any }\col{a}\neq\col{0}
$$ (eq19-chap5)

````

````{exercise}
:label: ex:5.3


What is the physical interpretation of the quantity $\frac12\col{u^T}\mat{M}\col{u}$?.

````
````{exercise}
:label: ex:5.4

Assume spatial dimension $d=3$.
Reorder the degrees of freedom in $\col u$ according to: first all velocities in $x_1$-direction, then $x_2$ and finally $x_3$: 

$$
  \col{u^T}=(u_1^1, u_1^2,\dots,u_1^{N_u},u_2^1, u_2^2,\dots,u^{N_u}_2,u_3^1, u_3^2,\dots,u_3^{N_u})
$$ (eq20-chap5)

Show that after reordering the matrix $\mat M$ becomes a block-diagonal matrix:

$$
   \mat{M} = \begin{pmatrix}
    \mat{m}& \mat{0}&\mat{0}\\
    \mat{0}& \mat{m}&\mat{0}\\
    \mat{0}& \mat{0}&\mat{m}
  \end{pmatrix}
$$ (eq21-chap5)
where each block is the same and given by the $N_u\times N_u$-matrix $\mat m$, having components $M_{km}$ given by Equation {eq}`eq16-chap5`.

````

````{exercise}
:label: ex:5.5

What is the physical interpretation of the sum of all entries of the matrix $\mat m$ as defined in {numref}`ex:5.4`?

````

For later use, we write $\vek N_{k}(\vek u_h)$ as follows

$$
    \vek N_{k}(\vek u_h)=\sum_{m=1}^{N_u} \ten L_{km}(\vek u_h)\cdot \vek u_m, \qquad k=1,\dots N_{u}
$$ (eq22-chap5)

where the tensors $\ten L_{km}(\vek u_h)$ are defined as

$$
 \ten L_{km}(\vek u_h) = \int_\Omega \rho \phi_k\vek u_h\nao\phi_m\,d\Omega, \qquad
  k,m=1,\dots N_{u}
$$ (eq23-chap5)

The column vector $\col N(\col u)$ can then be written as

$$
  \col{N}(\col{u})=\mat{L}(\col{u})\col{u} 
$$ (eq24-chap5)

where $\mat{L}(\col{u})$ has been defined as

$$
   \mat{L}(\col{u})=  
  \begin{pmatrix}
    \mat{L}_{11} & \mat{L}_{12} & \cdots & \mat{L}_{1N_u} \\
    \mat{L}_{21} & \mat{L}_{22} & \cdots & \mat{L}_{2N_u} \\
      \vdots & \vdots & \ddots & \vdots \\
    \mat{L}_{N_u1} & \mat{L}_{N_u2} & \cdots & \mat{L}_{N_uN_u}
  \end{pmatrix}
$$ (eq25-chap5)

with $\mat{L_{km}}$ the $d\times d$ matrices of the components of $\ten L_{km}(\vek u_h)$ with respect to a Cartesian coordinate system given by the unit vectors $\vek e_i$, $i=1,\dots,d$. The system Equations {eq}`eq18-chap5` can now be written as 

$$
\begin{align*}
\mat{M} \deriv{\smash{\col{u}}}t+\mat{L}(\col{u})\col{u} +\mat{A}\col{u}+\mat{B^T}\col{p} &= \col{f} \\
   \mat{B}\col{u}  &= \col{0}
\end{align*}
$$ (eq26-chap5)

or in full matrix form

$$
\begin{pmatrix}
  \mat{M} & \mat{0}\\
  \mat{0} & \mat{0}
\end{pmatrix}
\begin{pmatrix}
 \lderiv{\col{u}}t \\
 \col{0}
\end{pmatrix}
+
\begin{pmatrix}
  \mat{L}(\col{u}) +\mat{A}& \mat{B^T}\\
  \mat{B} & \mat{0}
\end{pmatrix}
\begin{pmatrix}
 \col{u} \\
 \col{p}
\end{pmatrix}=
\begin{pmatrix}
 \col{f} \\
 \col{0}
\end{pmatrix}
$$ (eq27-chap5)

````{exercise}
:label: ex:5.6

Show, that the matrix $\mat{L}(\col{u})$ is not symmetric, i.e. $\mat{L^T}\neq\mat{L}$.

````

For steady flows we have $\lderiv{\col{u}}t=\col{0}$ and the system of equations {eq}`eq26-chap5` reduces to

$$
\begin{align*}
\col{N}(\col{u}) +\mat{A}\col{u}+\mat{B^T}\col{p} &= \col{f} \\
   \mat{B}\col{u}  &= \col{0} 
\end{align*}
$$ (eq28-chap5)

Using Equation {eq}`eq24-chap5` this can be written as

$$
\begin{align*}
\mat{L}(\col{u})\col{u} +\mat{A}\col{u}+\mat{B^T}\col{p} &= \col{f} \\
   \mat{B}\col{u}  &= \col{0}
\end{align*}
$$ (eq29-chap5)

or in full matrix form

$$
\begin{pmatrix}
  \mat{L}(\col{u}) +\mat{A}& \mat{B^T}\\
  \mat{B} & \mat{0}
\end{pmatrix}
\begin{pmatrix}
 \col{u} \\
 \col{p}
\end{pmatrix}=
\begin{pmatrix}
 \col{f} \\
 \col{0}
\end{pmatrix}
$$ (eq30-chap5)

The discretized equations for the flow of Newtonian fluids with inertia as obtained in this section are nonlinear in the velocity unknowns $\col{u}$. In the next section we show how to solve the steady nonlinear equations using Picard and Newton-Raphson iteration techniques. The time-dependent equations need time discretization schemes, which will be introduced in the section thereafter.

## Steady flow: Picard and Newton-Raphson iteration

### Theory

The *Picard iteration scheme* for solving the steady system of equations Equations {eq}`eq29-chap5` is defined by a starting vector $\col u^{(0)}$ for the velocity and a sequence of solutions $\{\col{u}^{(j)},\col{p}^{(j)}\}$, $j=1,2,3,\dots$, given by

$$
\begin{align*}
\mat{L}(\col{u}^{(j-1)})\col{u}^{(j)} + \mat{A}\col{u}^{(j)}+\mat{B^T}\col{p}^{(j)} &= \col{f} \\
   \mat{B}\col{u}^{(j)} &= \col{0}
\end{align*}
$$ (eq31-chap5)

Note, that we do not need a starting value for the pressure. 


<a name="Remark:5.3"></a>
```{admonition} Remark 5.3
:class: note

The starting vector $\col{u}^{(0)}$ should be chosen as close as possible to the actual solution and preferably already fulfilling the Dirichlet boundary conditions. For that, we use the Stokes solution

$$
\begin{align*}
\mat{A}\col{u}^{(0)} +\mat{B^T}\col{p}^{(0)} &= \col{f} \\
   \mat{B}\col{u}^{(0)} &= \col{0}
\end{align*}
$$ (eq32-chap5)

Another possibility is that $\col{u}^{(0)}$ is the solution at a lower Reynolds number in a sequence of gradually increasing values of the Reynolds numbers. In the first step the Stokes solution is used for $\col{u}^{(0)}$.

```

```{admonition} Remark 5.4
:class: note

The system matrix $\mat{S}(\col{u}^{(j-1)})$, given by 

$$
  \mat{S}(\col{u}^{(j-1)})=
  \begin{pmatrix}
  \mat{L}(\col{u}^{(j-1)}) +\mat{A}& \mat{B^T}\\
  \mat{B} & \mat{0}
\end{pmatrix}
$$ (eq33-chap5)

is not symmetric and needs to be rebuilt for every iteration $j$.

```

As we saw with generalized Newtonian fluids, a Picard scheme converges linearly and a large number of iterations might be needed to obtain an accurate solution. As explained in {numref}`Chap4.6.1` a Newton-Raphson iteration shows quadratic convergence, provided the initial guess is close enough to the solution. Also we saw in {numref}`Chap4.6.4`, that a few Picard iterations followed by Newton-Raphson can greatly improve the performance by combining the larger convergence window of the Picard scheme with the fast convergence of the Newton-Raphson scheme. This is the approach we will follow also for solving the steady Navier-Stokes equations.

In order to find the linearized set of equations for the Newton-Raphson scheme we need an expression for the Jacobian matrix $\mat J(\col u)$. One way of doing this is taking direct derivatives with respect to $\col u$ of the discretized nonlinear set of equations, here given by Equations {eq}`eq28-chap5`. However, it is often easier to linearize the weak form before the discretization step. Since, here it is even more simple and really about linearizing the convection term directly, we will do the latter here.

Linearizing the convection term boils down to linearizing a quadratic term like $a^{(j+1)}b^{(j+1)}$ with $a^{(j+1)}=a^{(j)}+\Delta a$ and $b^{(j+1)}=b^{(j)}+\Delta b$:

$$
\begin{split}
  a^{(j+1)}b^{(j+1)}=(a^{(j)}+\Delta a)(b^{(j)}+\Delta b)&=
     a^{(j)}b^{(j)}+\Delta ab^{(j)}+a^{(j)}\Delta b+\Delta a\Delta b \\
        &=a^{(j)}b^{(j)}+\Delta ab^{(j)}+a^{(j)}\Delta b+\text{h.o.t.}\\
        &=a^{(j+1)}b^{(j)}+a^{(j)}b^{(j+1)}-a^{(j)}b^{(j)}+\text{h.o.t.}
\end{split} 
$$ (eq34-chap5)

where in the last line we have substituted the expression for $\Delta a$ and $\Delta b$ to obtain a linear expression in $a^{(j+1)}$ and $b^{(j+1)}$. The Newton-Raphson scheme can be obtained by removing the higher-order terms (h.o.t.).

````{exercise}
:label: ex:5.7

Show that a third-order term $abc$ can be linearized using:

$$
 a^{(j+1)}b^{(j+1)}c^{(j+1)}=a^{(j+1)}b^{(j)}c^{(j)}+a^{(j)}b^{(j+1)}c^{(j)}+a^{(j)}b^{(j)}c^{(j+1)}-2a^{(j)}b^{(j)}c^{(j)}+\text{h.o.t.}
$$ (eq35-chap5)

````

Now we are ready to linearize the convection term as follows, using Equation {eq}`eq34-chap5`:

$$
  \vek u^{(j+1)}\cdot\nao\vek u^{(j+1)}=\vek u^{(j+1)}\cdot\nao\vek u^{(j)}+\vek u^{(j)}\cdot\nao\vek u^{(j+1)}-\vek u^{(j)}\cdot\nao\vek u^{(j)}+\text{h.o.t.}
$$ (eq36-chap5)

The linearization of the non-linear term $\vek N_{k}(\vek u_h^{(j+1)})$ (see Equation {eq}`eq15-chap5` (second equation)) can be written as:

$$
  \vek N_{k}(\vek u_h^{(j+1)}) = \sum_{m=1}^{N_u} \ten P_{km}(\vek u_h^{(j)}) 
  \cdot \vek u^{(j+1)}_{h,m}- \vek N_{k}(\vek u_h^{(j)})+\text{h.o.t.}, \quad
  k=1,\dots N_{u}
$$ (eq37-chap5)

where the tensors $\ten P_{km}(\vek u_h)$ are defined as

$$
 \ten P_{km}(\vek u_h) = \int_\Omega \big(\rho \phi_k\vek u_h\nao\phi_m+\rho \phi_k\phi_m(\nao\vek u_h)^T\big)
 \,d\Omega, \qquad
  k,m=1,\dots N_{u}
$$ (eq38-chap5)

The linearization of the column vector $\col{N}(\col{u})$ can be written as

$$
  \col N(\col u^{(j+1)})=\mat P(\col u^{(j)})\col u^{(j+1)}-\col N(\col u^{(j)}) +\text{h.o.t.}
$$ (eq39-chap5)

where the matrix $\mat{P}(\col{u})$ has been defined as

$$
   \mat P(\col u)=  
  \begin{pmatrix}
    \mat{P}_{11} & \mat{P}_{12} & \cdots & \mat{P}_{1N_u} \\
    \mat{P}_{21} & \mat{P}_{22} & \cdots & \mat{P}_{2N_u} \\
      \vdots & \vdots & \ddots & \vdots \\
    \mat{P}_{N_u1} & \mat{P}_{N_u2} & \cdots & \mat{P}_{N_uN_u}
  \end{pmatrix}
$$ (eq40-chap5)

with $\mat{P_{km}}$ the $d\times d$ matrices of the components of $\ten P_{km}(\vek u_h)$ with respect to a Cartesian coordinate system given by the unit vectors $\vek e_i$, $i=1,\dots,d$. 

The *Newton-Raphson iteration scheme* is defined by a starting vector $\col{u^{(0)}}$ for the velocity and a sequence of solutions $\{\col{u}^{(j)},\col{p}^{(j)}\}$, $j=1,2,3,\dots$, given by

$$
\begin{align*}
\big[\mat{P}(\col{u}^{(j-1)}) +\mat{A}\big]\col{u}^{(j)}+\mat{B^T}\col{p}^{(j)} &= \col{f} + \col{N}(\col{u}^{(j-1)})\\
   \mat{B}\col{u}^{(j)} &= \col{0} 
\end{align*}
$$ (eq41-chap5)

For the starting vector we can use a Stokes solution as discussed in [Remark 5.3](#Remark:5.3).
A stopping criterium, such as $\Delta_u^{(j)}=\max_i|u_i^{(j)}-u_i^{(j-1)}|\leq\epsilon_u$ and $\Delta_p^{(j)}=\max_i|p_i^{(j)}-p_i^{(j-1)}|\leq\epsilon_p$ with $\epsilon_u$ and $\epsilon_p$ small positive values, needs to be defined to limit the number of iterations.

<a name="Remark:5.5"></a>
```{admonition} Remark 5.5
:class: note

The system matrix $\mat S(\col u^{(j-1)})$, given by 

$$
  \mat{S}(\col{u}^{(j-1)})=
  \begin{pmatrix}
  \mat{P}(\col{u}^{(j-1)}) +\mat{A}& \mat{B^T}\\
  \mat{B} & \mat{0}
\end{pmatrix}
$$ (eq42-chap5)

is not symmetric and needs to be rebuilt for every iteration $j$.

```

<a name="Remark:5.6"></a>
```{admonition} Remark 5.6
:class: note

Depending on the Reynolds number $\textit{Re}$, the Stokes solution as a starting vector might be too far from the actual solution and the Newton-Raphson diverges. The Picard iteration process has a much wider convergence window. Therefore, it is a good idea to start with a few Picard iteration followed by the Newton-Raphson process. 


```

````{exercise}
:label: ex:5.8


Show that the Newton-Raphson process can also be written as a starting vector $\col{u}^{(0)}$ for the velocity and a sequence of solutions $\{\col{u}^{(j)},\col{p}^{(j)}\}$, $j=1,2,3,\dots$, given by

$$
 \col{u}^{(j+1)} =\col{u}^{(j)} + \Delta \col{u}, \qquad \col{p}^{(j+1)} =\col{p}^{(j)} + \Delta \col{p}
 \qquad j=0,1,2,\dots
$$ (eq43-chap5)

with the iteration increment $\Delta \col{u}$ and  $\Delta \col{p}$ obtained from

$$
\begin{align*}
\big[\mat{P}(\col{u}^{(j)})+ \mat{A}\big]\Delta \col{u} +\mat{B^T}\Delta\col{p} &= \col{f}-\col{N}(\col{u}^{(j)})-\mat{A}\col{u}^{(j)}- \mat{B^T}\col{p}^{(j)} \\
   \mat{B}\Delta \col{u}  &= -\mat{B}\col{u}^{(j)}
\end{align*}
$$ (eq44-chap5)

````

### Convergence of the Newton-Raphson iteration: lid-driven cavity flow

We now solve the driven cavity problem (see {numref}`chap4.5.2`) for the Navier-Stokes equations using Newton-Raphson iteration. The domain is given by $\Omega=[-1,1]\times[-1,1]$ and therefore the length scale is $L=2$. The lid velocity is given by Equation {eq}`eq35-chap4`, giving a characteristic velocity of $U=1$. 
Using again $\mu=1$, the Reynolds number for this problem is $\textit{Re}=\rho U L/\mu=2\rho$, leaving the value of the density $\rho$ as a parameter to change the Reynolds number. We will be using an $N\times N$ mesh of 
Taylor-Hood $Q_2$-$Q_1$ elements (see {numref}`fig13-chap3`).

We first solve the flow for $\textit{Re}=1000$, $N=140$. In {numref}`fig1-chap5` we show the iteration process of Picard and Newton-Raphson. Like for the generalized Newtonian fluid, the Picard scheme converges linearly. The Newton-Raphson process requires at least one Picard iteration in order for it to be convergent at this Reynolds number. However, the convergence rate is much faster than the Picard scheme (more than linear). For low Reynolds numbers no Picard is needed, but for higher Reynolds numbers several are needed (say 10 at $\textit{Re}=10000$).


```{figure-md} fig1-chap5

<img src="media/chap5/fig1-chap5.png"  width="700px">

Difference between iterations for the driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. Shown are: Picard, Newton-Raphson iteration and one Picard iteration followed by Newton-Raphson iteration.
```

In {numref}`fig2-chap5` and {numref}`fig3-chap5` the streamlines are shown for $\textit{Re}=1000$, $N=140$.

```{figure-md} fig2-chap5

<img src="media/chap5/fig2-chap5.png"  width="700px">

Streamlines for the driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. The figure shows the contours of the negative streamfunction.  
```

```{figure-md} fig3-chap5

<img src="media/chap5/fig3-chap5.png"  width="700px">

Streamlines for the driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. The figure shows the contours of the positive streamfunction are shown.
```

```{figure-md} fig4-chap5

<img src="media/chap5/fig4-chap5.png"  width="700px">

Streamlines for the driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. Plots in {numref}`fig2-chap5` and {numref}`fig3-chap5` are merged.
```

At high Reynolds numbers thin boundary layers can be present. These boundary layers need to be resolved by the mesh in order to obtain an accurate solution. In {numref}`fig5-chap5` we show a contour plot of the effective strain rate $\dot\gamma_\text{e}$ and it can be seen that very thin boundary layers are present near the moving plate at the upper-left corner and on the right wall below the upper-right corner. The maximum value $\dot\gamma_\text{e}$ is in the layer near the plate and in {numref}`fig6-chap5` we give the error in this maximum value as a function of $N$. The error is computed using a solution for $N=500$ as a reference. The choice of $N=140$ is chosen such that the error is below 1\%. An error below $1$‰ requires at least $N=300$. In {numref}`fig7-chap5` it can be seen that for $N=140$ the number of elements across the boundary layer is 3--4, i.e.\ 7--9 nodal points. 
These boundary layers look like Blasius boundary layer flow ({cite}`Tritton1988`) and are expected to scale with $1/\sqrt{Re}$, i.e. increasing the Reynolds number with a factor of four will half the thickness of the boundary layer, increasing the necessary value of $N$ by two. Of course a mesh using equal element sizes in the whole domain is not an economical way of solving the problem. Locally refined meshes, possibly adaptive, would be much more efficient, but the topic is beyond the scope of these lecture notes.

```{figure-md} fig5-chap5

<img src="media/chap5/fig5-chap5.png"  width="700px">

Contour lines of the effective strain rate $\dot\gamma_\text{e}$ for the driven cavity proble with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$.
```

```{figure-md} fig6-chap5

<img src="media/chap5/fig6-chap5.png"  width="700px">

The error in the maximum of $\dot\gamma_\text{e}$ for the driven cavity problem with the Navier-Stokes equations as a function of $N$, as compared to a computation using $N=500$ as a reference. $\textit{Re}=1000$. The horizontal green and blue lines are an error threshold of $1\%$ and $1$‰, respectively.
```

```{figure-md} fig7-chap5

<img src="media/chap5/fig7-chap5.png"  width="700px">

The mesh on top of the contours of $\dot\gamma_\text{e}$ at the upper-left boundary layer for the driven cavity problem with the Navier-Stokes equations for $N=140$. $\textit{Re}=1000$.
```

At higher Reynolds number the Blasius boundary layer is unstable and becomes turbulent (in 3D) {cite}`Tritton1988`. It is expected we will see unstable flow for higher Reynolds in the driven cavity flow as well. Simulations must be three-dimensional, in that case.

(Chap5.5)=
## Unsteady flow: time discretization

### General

For unsteady flow, we need to discretize the system of equations {eq}`eq18-chap5` in time. Since, we applied the method of lines, we basically have obtained a system of ordinary differential equations (ODEs). In principle, we can apply a standard time discretization method for the system of ODEs in the regular form used in literature (see {cite}`Vuik2015` for an introductionary text and {cite}`Hundsdorfer2003` for an extensive overview):

$$

  \dot{\col{u}}(t)=\col{F}(t,\col{u}),\quad t>0,\qquad \col{u}(0)=\col{u_0} 
$$ (eq45-chap5)

where $\col{u}$ is a column vector of size $N$. Furthermore, we used the short-hand notation $\dot{\col{u}}=\lderiv{\col{u}}t$. However, the system {eq}`eq18-chap5` is not in this regular form:

1. A mass matrix $\mat M$ is present as factor in front of $\dot{\col{u}}$.
1. The incompressibility constraint Equation {eq}`eq18-chap5` (second equation) does not contain a time derivative.
   

The first item can be dealt with easily, by multiplying {eq}`eq18-chap5` (first equation) by $\mat{M}^{-1}$, at least formally. We will deal with the second item later and, for now, ignore this issue and go forward with introducing time discretization for Equation {eq}`eq45-chap5`.

Analyzing a nonlinear system, like Equation {eq}`eq45-chap5`, is not easy. Therefore, it is common to restrict the analysis to a linear system of ODEs {cite}`Hundsdorfer2003`:

$$
  \dot{\col{u}}(t)=\mat{A}\col{u}(t) + \col{g}(t), \quad t>0, \qquad \col{u}(0)=\col{u_0} 
$$ (eq46-chap5)

For the analysis of the stability of this system, we solve a system with a perturbed initial condition $\col{u_0}+\col{\epsilon_0}$ and get a perturbed solution $\col{u(t)}+\col{\epsilon(t)}$. It is easy to show that the solution for the perturbation becomes

$$
  \dot{\col{\epsilon}}(t)=\mat{A}\col{\epsilon}(t), \quad t>0, \qquad \col{\epsilon}(0)=\col{\epsilon_0} 
$$ (eq47-chap5)

i.e. for stability analysis it is sufficient to study the homogeneous system. A system of ODEs is called *absolutely stable* if

$$
   \lim_{t\rightarrow\infty} |\col\epsilon(t)| = 0 
$$ (eq48-chap5)


````{exercise}
:label: ex:5.9

Derive Equation {eq}`eq47-chap5`

````

````{exercise}
:label: ex:5.10

Perturb the nonlinear system Equation {eq}`eq45-chap5`, i.e. solve for a perturbed solution $\col{u}(t)+\col{\epsilon}(t)$ starting from a perturbed initial condition $\col{u_0}+\col{\epsilon_0}$. Show that for small $\col{\epsilon}(t)$ we have

$$
   \dot{\col{\epsilon}}(t)\approx\mat{J_F}(t,\col{u})\col{\epsilon}(t), \quad t>0, \qquad \col{\epsilon}(0)=\col{\epsilon_0}
$$ (eq49-chap5)

where $\mat{J_F}=\plderiv{\col{F}}{\col{u}}$. Hence, the Jacobian matrix replaces the constant matrix $\mat A$ for stability analysis.

````

Assuming the coefficient matrix $\mat A$ is diagonizable, the stability analysis can be done using a simple *scalar test equation*

$$
  \dot{u}(t)=\lambda u(t),\quad t>0, \qquad u(0)=u_0 
$$ (eq50-chap5)

where for $\lambda$, the eigenvalues $\lambda_i$, $i=1,2,\dots,N$ must be substituted. Note, that for a non-symmetric matrix $\mat A$, the eigenvalues $\lambda_i$ can have complex values, hence $\lambda$ can have any value in the complex plane ($\lambda\in \mathbb{C}$). The solution of the scalar test equation {eq}`eq50-chap5` is given by

$$
   u(t) = u_0e^{\lambda t}
$$ (eq51-chap5)

which shows that the test equation is absolutely stable if the real part of $\lambda$ has a negative value ($\mathrm{Re}(\lambda)<0$). Consequently, the original system Equation {eq}`eq46-chap5` is absolutely stable if *all* $\mathrm{Re}(\lambda_i)<0$, $i=1,2,\dots,N$.

For the time-discretization of the system of ODEs Equation {eq}`eq45-chap5` we define the numerical approximation $\col{u_n}$ of $\col{u}(t_n)$ at the time points $t_n$, $n=0,1,2,\dots$ with $t_0=0$, $t_{n+1}>t_n$ (see {numref}`fig8-chap5`). The difference between the time points, the *time step* $\Delta t_n=t_{n+1}-t_n$, does not have to be constant, but we will often consider only the case of a constant time step $\Delta t_n=\Delta t$ for all $n$. In that case, we have $t_n=n\Delta t$.

```{figure-md} fig8-chap5

<img src="media/chap5/fig8-chap5.png"  width="700px">

Time points $t_n$ and time steps $\Delta t_n$, $n=0,1,2,\dots$.
```

The numerical approximations $\col{u_n}$, $n=1,2,\dots$ are now computed one-by-one (time-stepping) starting from the known/imposed initial value $\col{u_0}$. For that, we use a time-discretization method, of which there are many. For the purpose of these lecture notes, we only discuss the most common ones used for the Navier-Stokes equations.

A time-discretization method must by *consistent* and *stable* in order for the numerical solution to *converge* to the exact solution at a fixed time $t=T>0$ for $\Delta t\rightarrow0$. Consistency means that the method must converge to the ODE locally and stability means that all $\lambda_i\Delta t$ must be in the *region of absolute stability* of the method for $\Delta t\rightarrow0$. The region of absolute stability, or just, *stability region* of a method is the region in the complex plane in which $\lambda\Delta t$ must be chosen in order for the numerical solution of the scalar test equation to be absolutely stable, i.e. $\lim_{n\rightarrow\infty}u_n\rightarrow 0$.

For the purpose of these lecture notes, we will only consider time-discretization methods that are *unconditionally stable*, i.e. the stability region includes the full left-half complex plane. This means, that if all eigenvalues of the discretized Navier-Stokes equation have negative real parts (damping eigenvalues), we can take \emph{any} time step $\Delta t$ without worrying about numerical instabilities due to the time discretization scheme.

### Time-discretization methods

The most popular methods are the single-step methods. This means that $\coll{u}{n+1}$ is computed from data at the previous time point $t_n$ only, i.e. the value of $\col{u_n}$. The single-step methods can be derived by integrating Equation {eq}`eq45-chap5` from $t_n$ to $t_{n+1}$:

$$
 \coll{u}{}(t_{{n+1}})-\coll{u}{}(t_n)=\int_{t_n}^{t_{{n+1}}} \coll{F}{}(\tau,\coll{u}{}(\tau))\,d\tau
$$ (eq52-chap5)

#### The backward Euler method

The most basic method is the *backward Euler* method, which can be found by replacing in Equation {eq}`eq52-chap5` $\col{u}(t_n)$ with the approximation $\col{u_n}$ and replacing the integrand with the value of $\col{F}$ at the end of the time step, i.e. at $t_{n+1}$. In this way we obtain
the following time stepping scheme (constant time step $\Delta t$):

$$
 \coll{u}{n+1} = \col{u_n} + \Delta t\col{F}(t_{n+1},\coll{u}{n+1}),\qquad n=0,1,2,\dots
$$ (eq53-chap5)

or

$$
 \frac{\coll{u}{n+1} - \coll{u}{n}}{\Delta t}=\col{F}(t_{n+1},\coll{u}{n+1}),\qquad n=0,1,2,\dots
$$ (eq54-chap5)

The method is called *implicit*, because the right-hand side expression now depends on the still unknown value of $\coll{u}{n+1}$. The backward Euler method is also called the *implicit Euler* method. For non-linear $\col{F}$, the backward Euler method requires an iteration method (like Picard or Newton-Raphson) to obtain the solution.

The global truncation error, i.e. the time-discretization error for a fixed time point is $\mathcal{O}(\Delta t)$ {cite}`Hundsdorfer2003`. Hence, the backward Euler method is called a *first-order* method.

To find the (absolute) stability region we solve the test equation Equation {eq}`eq50-chap5` using the backward Euler method:

$$
  u_{n+1}=u_{n} + \lambda\Delta t u_{n+1},\qquad n=0,1,2,\dots
$$ (eq55-chap5)

leading to

$$
  u_{n+1}=\frac1{1-\lambda\Delta t}u_n=Q(\lambda\Delta t)u_n,\qquad n=0,1,2,\dots
$$ (eq56-chap5)

where $Q(z)=1/(1-z)$ is the *amplification factor*. The (absolute) stability region is given by $|Q(z)|<1$ in the complex plane ($z\in\mathbb{C}$). The stability region is shown in Figure~\ref{fig:euler_implicit}.

```{figure-md} fig9-chap5

<img src="media/chap5/fig9-chap5.png"  width="700px">

Stability region (shaded) of the backward Euler method.
```

For stability the time step $\Delta t$ must be such that all values of $z=\lambda_i\Delta t$, $i=1,2,\dots,N$ are in the stability region. Since the whole left-half plane ($z\in\mathbb{C}^-$) is stable, the backward Euler method is \emph{unconditionally stable} (it is stable for any time-step $\Delta t$ (provided $\mathit{Re}(\lambda_i)\leq0$)). The backward Euler method has another property that can be very useful for stiff equations:

$$
 \lim_{z\rightarrow\infty}|Q(z)|\rightarrow 0
$$ (eq57-chap5)

i.e. the amplification factor tends to zero for very large values of $z=\lambda\Delta t$. 


<a name="Remark:5.7"></a>
```{admonition} Remark 5.7

The stability region of the backward Euler method extends even to eigenvalues with positive real parts. This means, that eigenvalues showing growth in the real system are damped by this method for large time steps. This can be useful if these modes are unwanted side effects of the model. However, if you are after detection of physical instabilities, it might mean you fail to detect them if the time step is taken too large. 

```


#### The trapezoidal method

The backward Euler method is only first-order accurate. This means that obtaining an acceptable accuracy requires a very small time step, and consequently a lot of time steps. In practise, a higher-order method (usually second-order) is preferred, requiring less work for given accuracy. See {cite}`Vuik2015` for a discussion on this topic. In this subsection, we introduce a very popular second-order method: the trapezoidal method.

Evaluating the integrand in Eq.~\eqref{eq:integralstep} using the trapezoidal integration scheme, we get the *trapezoidal* method (constant time step $\Delta t$):

$$
 \coll{u}{n+1} = \col{u_n} + \Delta t\frac12\big(\col{F}(t_{n},\col{u_{n}})+\col{F}(t_{n+1},\coll{u}{n+1})\big),\qquad n=0,1,2,\dots
$$ (eq58-chap5)

or

$$
 \frac{\coll{u}{n+1} - \col{u_n}}{\Delta t}=\frac12\big(\col{F}(t_{n},\coll{u}{n})+\col{F}(t_{n+1},\coll{u}{n+1})\big),\qquad n=0,1,2,\dots
$$ (eq59-chap5)

The method is *implicit* and, like the backward Euler method, requires an iteration method (like Picard or Newton-Raphson) to obtain the solution for non-linear $\col{F}$. 

The global truncation error is $\mathcal{O}(\Delta t^2)$ {cite}`Hundsdorfer2003`. Hence, we say the trapezoidal method is a *second-order* method.

To find the (absolute) stability region we solve the test equation Equation {eq}`eq50-chap5` using the trapezoidal method:

$$
  u_{n+1}=u_{n} + \lambda\Delta t \frac12(u_n+u_{n+1}),\qquad n=0,1,2,\dots
$$ (eq60-chap5)

leading to

$$
  u_{n+1}=\frac{1+\frac12\lambda\Delta t}{1-\frac12\lambda\Delta t}u_n=Q(\lambda\Delta t)u_n,\qquad n=0,1,2,\dots
$$ (eq61-chap5)

where $Q(z)=(1+\frac12z)/(1-\frac12z)$ is the *amplification factor*. The (absolute) stability region is given by $|Q(z)|<1$ in the complex plane ($z\in\mathbb{C}$). The stability region is shown in {numref}`fig10-chap5`.

```{figure-md} fig10-chap5

<img src="media/chap5/fig10-chap5.png"  width="700px">

Stability region (shaded) of the trapezoidal method.
```

For stability the time step $\Delta t$ must be such that all values of $z=\lambda_i\Delta t$, $i=1,2,\dots,N$ are in the stability region. The whole left-half plane ($z\in\mathbb{C}^-$) is stable. The trapezoidal method is *unconditionally stable*, since it is stable for any time-step $\Delta t$ (provided $\mathit{Re}(\lambda_i)\leq0$). The trapezoidal method is suited for problems with large eigenvalues (stiff problems), but some care need to 
be given to the handling of initial conditions, since

$$
 \lim_{z\rightarrow\infty}Q(z)\rightarrow -1
$$ (eq62-chap5)

i.e. the amplification factor tends to -1 for very large value of $\lambda\Delta t$. This means that if `fast modes' with large $\lambda\Delta t$ are not yet in a steady state initially, they keep wiggling around the steady state, to be seen as wiggles in time without damping. In that case, it might be better to first start with one or more backward Euler steps.

<a name="Remark:5.8"></a>
```{admonition} Remark 5.8

The stability region of the trapezoidal method is the left-half plane. The right-half place is unstable. The two regions are separated by the imaginary axis, on which $|Q(z)|=1$. These stability regions conform to the stability behavior of the real system and can be useful for detection of physical instabilities.

```

<a name="Remark:5.9"></a>
```{admonition} Remark 5.9

When used in combination with the spatial discretization of a PDE, like we do here for the Navier-Stokes equations, the trapezoidal method is also known as the *Crank-Nicolson* method.

```

#### The $\theta$-method

The trapezoidal method is second-order accurate, but suffers from the lack of damping for large eigenvalues. The backward Euler method damps large eigenvalues effectively, but it is only first-order accurate. 
The $\theta$-method tries to be a mix between the two.

Evaluating the integrand in Eq.~\eqref{eq:integralstep} using an intermediate value for the integrand, we get the $\theta$-method (constant time step $\Delta t$):

$$
 \coll{u}{n+1} = \coll{u}n + \Delta t\big((1-\theta)\col{F}(t_{n},\coll{u}{n})+\theta\col{F}(t_{n+1},\coll{u}{n+1})\big),\qquad n=0,1,2,\dots
$$ (eq63-chap5)

or

$$
 \frac{\coll{u}{n+1} - \coll{u}{n}}{\Delta t}=(1-\theta)\col{F}(t_{n},\coll{u}{n})+\theta\col{F}(t_{n+1},\coll{u}{n+1}),\qquad n=0,1,2,\dots
$$ (eq64-chap5)

with special cases backward Euler method ($\theta=1$) and trapezoidal method ($\theta=\frac12$).
The method is \emph{implicit} and requires an iteration method (like Picard or Newton-Raphson) to obtain the solution for non-linear $\col F$. 

The global truncation error is $\mathcal{O}(\Delta t)$ {cite}`Hundsdorfer2003`.
Hence, the $\theta$-method is a *first-order* method.

To find the (absolute) stability region we solve the test equation Equation {eq}`eq50-chap5` using the $\theta$-method:

$$
  u_{n+1}=u_{n} + \lambda\Delta t((1-\theta)u_n+ \theta u_{n+1}),\qquad n=0,1,2,\dots
$$ (eq65-chap5)

leading to

$$
  u_{n+1}=\frac{1+(1-\theta)\lambda\Delta t}{1-\theta\lambda\Delta t}u_n=Q(\lambda\Delta t)u_n,\qquad n=0,1,2,\dots
$$ (eq66-chap5)

where

$$
 Q(z)=\frac{1+(1-\theta)z}{1-\theta z}
$$ (eq67-chap5)

is the *amplification factor*. The (absolute) stability region is given by $|Q(z)|<1$ in the complex plane ($z\in\mathbb{C}$). The stability region is shown in {numref}`fig11-chap5` for two values of $\theta$.

```{figure-md} fig11-chap5

<img src="media/chap5/fig11-chap5.png"  width="700px">

Stability region (shaded) of the $\theta$-method. $\theta=0.55$.
```

```{figure-md} fig12-chap5

<img src="media/chap5/fig12-chap5.png"  width="700px">

Stability region (shaded) of the $\theta$-method. $\theta=0.75$.
```

For stability the time step $\Delta t$ must be such that all values of $z=\lambda_i\Delta t$, $i=1,2,\dots,N$ are in the stability region. For $\theta\geq\frac12$, the whole left-half plane ($z\in\mathbb{C}^-$) is stable. The $\theta$-method for $\theta\geq\frac12$ is *unconditionally stable*, since it is stable for any time-step $\Delta t$ (provided $\mathit{Re}(\lambda_i)\leq0$). The $\theta$-method is therefore suited for stiff problems. Furthermore, 

$$
 \lim_{z\rightarrow\infty}Q(z)\rightarrow -\frac{1-\theta}{\theta}
$$ (eq68-chap5)

i.e. the amplification factor tends to $-(1-\theta)/\theta$ for very large value of $\lambda\Delta t$. This means that for $\theta>\frac12$, “fast modes” having a large $\lambda\Delta t$ and are not yet in a steady state initially, wiggle around the steady state, but also damp with this factor in each time step. 

<a name="Remark:5.10"></a>
```{admonition} Remark 5.10

The region of absolute stability of the $\theta$-method for $\theta>\frac12$ is the outside region of the circle having it's center at $z=1/(2\theta-1)$ and a radius of $1/(2\theta-1)$.

```

#### Other methods

Many more time-discretization methods exist and some are also used for solving Navier-Stokes equations. Reasons for preferring these beyond the ones introduced in the previous section include: ease of implementation, CPU time, stability, accuracy and adaptivity. It is beyond the 
scope of these lecture notes to give a full overview and we refer to the literature  (see, for example {cite}`Hundsdorfer2003`).


### Application to the Navier-Stokes equations

Application of the various time-discretization schemes to the system of equations {eq}`eq18-chap5` is quite straightforward. Let's repeat the set of equations:

$$
\begin{align*}
\mat M \dot{\col u}+\col N(\col u) +\mat A\col u+\mat B^T\col p &= \col f \\
   \mat B\col u  &= \col 0 
\end{align*}
$$ (eq69-chap5)

First, we apply the backward Euler method given in Equation {eq}`eq53-chap5`. This requires multiplying Equation {eq}`eq69-chap5` (first equation) with $\mat{M}^{-1}$, then applying Equation {eq}`eq53-chap5`, and finally multiplying with
$\mat M$ to arrive at:

$$
  \mat{M}\frac{\coll{u}{n+1}-\coll{u}{n}}{\Delta t}+\col{N}(\coll{u}{n+1}) +\mat{A}\coll{u}{n+1}+\mat{B^T}\coll{p}{n+1} = \coll{f}{n+1}
$$ (eq70-chap5)

where we divided the equation by $\Delta t$. Then, we apply the incompressibility constraint Equation {eq}`eq69-chap5` (second equation) to the unknown velocity vector $\coll{u}{n+1}$ and arrive at the system of equations
for obtaining $(\coll{u}{n+1},p_{n+1})$ from $\coll{u}{n}$ (time-stepping):

$$
\begin{align*}
    \col{N}(\coll{u}{n+1}) +(\frac1{\Delta t}\mat{M}+\mat{A})\coll{u}{n+1}+\mat{B^T}\coll{p}{n+1} &= \coll{f}{n+1}+ \frac1{\Delta t}\mat{M}\coll{u}{n}\\
\mat{B}\coll{u}{n+1}  &= \col{0}
\end{align*}
$$ (eq71-chap5)

Like the steady state equations, this is a non-linear set of equations that needs to be solved by iteration (Picard or Newton-Raphson).

<a name="Remark:5.10"></a>
```{admonition} Remark 5.11

The time-stepping scheme using backward Euler obeys the correct initial conditions for Navier-Stokes, i.e. the velocity field $\col{u_0}$ needs to be specified and the pressure field $\col{p_0}$ should not be specified. This is related to the way the backward Euler method is constructed: the function is evaluated at the end of the time step only.

```

Now, we apply the trapezoidal method given in Equation {eq}`eq58-chap5`. This requires multiplying Equation {eq}`eq69-chap5` (first equation) with $\mat{M}^{-1}$, then applying Equation {eq}`eq58-chap5`, and finally multiplying with
$\mat{M}$ to arrive at:

$$
\begin{multline}
   \mat{M}\frac{\coll{u}{n+1}-\coll{u}{n}}{\Delta t}+\frac12\left(\col{N}(\coll{u}{n+1}) +\mat{A}\coll{u}{n+1}+\mat{B}^T\coll{p}{n+1}\right)\\
   +\frac12\left(\col{N}(\coll{u}{n}) +\mat{A}\coll{u}{n}+\mat{B^T}\coll{p}{n}\right) = \frac12\coll{f}{n+1}+\frac12\coll{f}{n}
\end{multline}
$$ (eq72-chap5)

where we divided the equation by $\Delta t$. Then, we apply the incompressibility constraint Equation {eq}`eq69-chap5` (second equation) to the unknown velocity vector $\coll{u}{n+1}$ and arrive at the system of equations for obtaining $(\coll{u}{n+1},p_{n+1})$ from $(\coll{u}{n},\coll{p}{n})$ (time-stepping):

$$
\begin{align*}
\begin{split}
   \frac12 \col{N}(\coll{u}{n+1}) +(\frac1{\Delta t}\mat{M}+\frac12\mat{A})\coll{u}{n+1}+\frac12\mat{B^T}\coll{p}{n+1} &= \frac12\coll{f}{n+1}+\frac12\coll{f}{n}-\frac12 \col{N}(\coll{u}{n})\\
         &\qquad+(\frac1{\Delta t}\mat{M}-\frac12\mat{A})\coll{u}{n}
   -\frac12\mat{B^T}\coll{p}{n}
\end{split}
   \\
\mat{B}\coll{u}{n+1}  &= \col{0} 
\end{align*}
$$ (eq73-chap5)

Like the steady state equations, this is a non-linear set of equations that needs to be solved by iteration (Picard or Newton-Raphson).

<a name="Remark:5.12"></a>
```{admonition} Remark 5.12

The time-stepping scheme using the trapezoidal method violates the correct initial conditions for Navier-Stokes, since the pressure field $\coll{p}{0}$ must be specified to get the stepping going. This is related to the way the trapezoidal method is constructed: the function is evaluated by averaging the beginning and end of the time step. This might lead to wiggles in time for the pressure field (see next section) if there is a jump in pressure for $t=0$ (see next section). A way to avoid the problem entirely is using a backward Euler method in the first time step. Alternatively, it is possible to define “a
time step averaged pressure” $\coll{p}{n+\frac12} = (\coll{p}{n+1} + \coll{p}{n})/2$, instead of the pressures at the
start/end of a time interval.

```

<a name="Remark:5.13"></a>
```{admonition} Remark 5.13

By multiplying Equation {eq}`eq74-chap5` (second equation) with a factor $\frac12$, the Stokes part of the matrix can be made symmetric.

```

````{exercise}
:label: ex:5.11

Show that applying a $\theta$-method leads to

$$
 \begin{align*}
\begin{split}
   \theta \col{N}(\coll{u}{n+1}) +(\frac1{\Delta t}\mat{M}+\theta\mat{A})\coll{u}{n+1}+\theta\mat{B}^T\coll{p}{n+1} &= \theta\coll{f}{n+1}+(1-\theta)\coll{f}{n}-(1-\theta) \col{N}(\coll{u}{n})\\
         &\qquad+(\frac1{\Delta t}\mat{M}-(1-\theta)\mat{A})\coll{u}{n}
   -(1-\theta)\mat{B}^T\coll{p}{n}
\end{split}
   \\
\mat{B}\coll{u}{n+1}  &= \col{0} 
\end{align*}
$$ (eq74-chap5)

Like the trapezoidal method, the $\theta$-method violates the correct initial conditions for Navier-Stokes the pressure field. Why? How can you circumvent this problem?


````

````{exercise}
:label: ex:5.12

The *two-step* BDF2 time-discretization method {cite}`Hundsdorfer2003` is given by:

$$
   \frac32\coll{u}{n+1}-2\coll{u}{n}+\frac12\coll{u}{n-1}=\Delta t\coll{F}{n+1}
$$ (eq75-chap5)

where $\coll{F}{n+1}=\col{F}(t_{n+1},\coll{u}{n+1})$.
Show that applying the BDF2 method leads to

$$
 \begin{align*}
    \col{N}(\coll{u}{n+1}) +(\frac{3}{2\Delta t}\mat{M}+\mat{A})\coll{u}{n+1}+\mat{B^T}\coll{p}{n+1} &= \coll{f}{n+1}+ \frac1{\Delta t}\mat{M}(2\coll{u}{n}- \frac12\coll{u}{n-1})\\
\mat{B}\coll{u}{n+1}  &= \col{0}
\end{align*}
$$ (eq76-chap5)

The BDF2 method (from *backward difference formula*) is second-order accurate in time, unconditionally stable and the amplification factor tends to zero for large time steps. It is therefore quite popular for stiff systems. Also the discretization does not include $\coll{p}{n}$, avoiding pressure wiggles in time. A drawback of this method is that the first step requires a single-step method. Why?


````


### Transient solution of the driven cavity problem

We now solve the unsteady driven cavity problem (see {numref}`Chap4.5.2`) for the Navier-Stokes equations. The domain is given by $\Omega=[-1,1]\times[-1,1]$ and therefore the length scale is $L=2$. The lid velocity is given by Equation {eq}`eq35-chap4`, giving a characteristic velocity of $U=1$. 
Using again $\mu=1$, the Reynolds number for this problem is $\textit{Re}=\rho U L/\mu=2\rho$, leaving the value of the density $\rho$ as a parameter to change the Reynolds number. We will be using an $N\times N$ mesh of 
Taylor-Hood $Q_2$-$Q_1$ elements (see {numref}`fig17-chap4`).

We solve the flow for $\textit{Re}=1000$, $N=140$. To avoid infinite acceleration of the fluid we can start from rest and gradually increase the lid velocity from 0 to 1. Another possibility is to start from a non-zero solution that already fulfills the velocity boundary condition, for example the Stokes ($\rho=0$) solution of the same problem. We choose the latter option and set $(\col{u}{0},\col{p}{0})$ to the Stokes solution.

In {numref}`fig13-chap5`  we show  $\|p_h\|$ as a function of time $t$ for the trapezoidal method (see Equation {eq}`eq34-chap3` for the definition of the area-scaled $L^2$-norm $\|\cdot\|$). Due to the jump in pressure (the initial value of $\|p_0\|$ is around $2.2$), the pressure solution keeps wiggling in time and does not damp. Switching to a backward Euler in the first step removes this problem entirely. The $\theta$-method has similar problems (see {numref}`fig14-chap5`), but has a damping wiggle. This suggests, that taking $\theta$ slightly larger than $\frac12$ can remove unphysical pressure fluctuations in the trapezoidal method, while maintaining accuracy. Note, that only the pressure is affected, since there is no jump in $\col{u}$ at $t=0$.

```{figure-md} fig13-chap5

<img src="media/chap5/fig13-chap5.png"  width="700px">

$\|p_h\|$ as a function of time for the driven cavity problem with the Navier-Stokes equations: trapezoidal method compared with the trapezoidal method having backward Euler in the first time step $\textit{Re}=1000$, $N=140$. $\Delta t = 0.1$.
```

```{figure-md} fig14-chap5

<img src="media/chap5/fig14-chap5.png"  width="700px">

$\|p_h\|$ as a function of time for the driven cavity problem with the Navier-Stokes equations: $\theta$-method with $\theta=0.55$ compared with the trapezoidal method having backward Euler in the first time step. $\textit{Re}=1000$, $N=140$. $\Delta t = 0.1$.
```

In {numref}`fig15-chap5` we show $\|\vek u_h\|$ and $\|p_h\|$ as a function of time $t$ (see Equation {eq}`eq34-chap3` for the definition of the area-scaled $L^2$-norm $\|\cdot\|$). Note, that $\frac12\rho A\|\vek u_h\|^2$ is the kinetic energy. We have used the trapezoidal method with backward Euler in the first step and
$\Delta t = 0.1$. Starting from the Stokes solution the value $\|\vek u_h\|$ gradually changes (there is no jump from the initial value at $t=0$). However, the initial value of $\|p_0\|$ is around $2.2$ and there is a jump in pressure at $t=0$. Also plotted are the steady state values of $\|\vek u_h\|$ and $\|p_h\|$. It takes a long time to reach the steady state in a start-up flow for high Reynolds number. The reason is that the diffusion (due to the viscosity) is slow compared to the convection. Note, that the diffusion length is typically $\ell=\sqrt{\mu t/\rho}$. This means that for $t=50$ (roughly the initial transient) we have $\ell\approx0.16L$. After the initial transient the difference with the steady state value dies out exponentially, approximately proportional to $\exp(-t/29.3)$ as can be seen in the {numref}`fig17-chap5`[^1]. The eventual steady state is therefore stable for this Reynolds number[^2]. 

For high values of Reynolds, the flow becomes unstable and the steady state will never be reached. We should note however, that such instability could be of a numerical nature, depending on the refinement of the mesh. See {cite}`Erturk2009` for a discussion on this subject. As already discussed, the boundary layers become unstable, which is a 3D instability and cannot be predicted using a 2D simulation and therefore it doesn't make much sense, physically, to pursue the current example to higher Reynolds numbers. In {cite}`Erturk2009` it is even stated that the flow is likely to be three-dimensional even at $\textit{Re}=1000$. 


```{figure-md} fig15-chap5

<img src="media/chap5/fig15-chap5.png"  width="700px">

$\|\vek u_h\|$ as a function of time for the driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. Trapezoidal method with a backward Euler method in the first step, $\Delta t = 0.1$.
```

```{figure-md} fig16-chap5

<img src="media/chap5/fig16-chap5.png"  width="700px">

$\|p_h\|$ as a function of time for the driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. Trapezoidal method with a backward Euler method in the first step, $\Delta t = 0.1$.
```

```{figure-md} fig17-chap5

<img src="media/chap5/fig17-chap5.png"  width="700px">

$|\|\vek u_h(t)\|-\|\vek u_h\|_\text{steady}|$ as a function of time for the
driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. Trapezoidal method with a backward Euler method in the first step, $\Delta t = 0.1$.
```

```{figure-md} fig18-chap5

<img src="media/chap5/fig18-chap5.png"  width="700px">

$\|p_h(t)\|-\|p_h\|_\text{steady}|$ as a function of time for the
driven cavity problem with the Navier-Stokes equations. $\textit{Re}=1000$, $N=140$. Trapezoidal method with a backward Euler method in the first step, $\Delta t = 0.1$.
```























[^1]: We show the results up to time $t=300$. For larger times when the pressure differences becomes smaller, small pressure oscillations show up, that can be removed by using the $\theta$-method with a value of slighly larger than $\frac12$.
[^2]: This can also be verified by substituting the steady state solution for the initial solution $(\vek u_0,p_0)$ and show that the time-dependent never comes out of numerical noise.
